<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Array Binding Tests</title>
    <link rel="stylesheet" href="../node_modules/qunitjs/qunit/qunit.css">
    <script src="../node_modules/qunitjs/qunit/qunit.js"></script>
    <script src="../src/Registry.js"></script>
    <script src="../src/Subscriber.js"></script>
    <script src="../src/UniqueRoot.js"></script>
    <script src="../src/BindingRoot.js"></script>
    <script src="../src/ViewModel.js"></script>
    <script src="../src/Property.js"></script>
    <script src="../src/Binding.js"></script>
    <script src="../src/ArrayBinding.js"></script>
    <script src="../src/ArrayElement.js"></script>
    <script src="../src/Push.js"></script>
    <script src="../src/Pop.js"></script>
    <script src="../src/Shift.js"></script>
    <script src="../src/Unshift.js"></script>
    <script src="../src/Splice.js"></script>
    <script src="../src/Sort.js"></script>
    <script src="../src/Reverse.js"></script>
    <script src="../src/ObjectBinding.js"></script>
  	<script src="../src/Serialisable.js"></script>
    <script src="../src/DomWatcher.js"></script>
    <script src="../src/Datum.js"></script>
    <script src="../src/Dependant.js"></script>
    <script src="../src/Text.js"></script>
    <script src="../src/Value.js"></script>
    <script src="../src/Init.js"></script>
    <script src="../src/Update.js"></script>
    <script src="../src/Click.js"></script>
  </head>
  <body>
    <style>
		#qunit ~ * {
			display: none;
		}
    </style>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script>
		QUnit.module("", {

			teardown: function() {

				Subscriber.prototype = new Registry();
				Binding.prototype = new Subscriber();
				Datum.prototype = new Subscriber();
				Text.prototype = new Subscriber();
				Value.prototype = new Subscriber();
				Update.prototype = new Subscriber();
				UniqueRoot.prototype = new Subscriber();
				BindingRoot.prototype = new UniqueRoot();
				BindingRoot.ObjectBinding.prototype = new Subscriber();
				BindingRoot.ViewModel.prototype = new Subscriber();
				BindingRoot.ArrayBinding.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Push.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Pop.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Shift.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Unshift.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Splice.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Sort.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Reverse.prototype = new Subscriber();
			}
		});
    </script>
    <div id="each" data-bind="each">
      <div id="inner-each"></div>
    </div>
    <script>
		QUnit.test("Remove element when bound to empty array", function(assert) {

			function ArrayBindingObject() {

				this.each = [];
			}

			var element = document.querySelector("#each");

			var inner = document.querySelector("#inner-each_0");

			var each = new ArrayBindingObject();

			var root = new BindingRoot(each);

			assert.ok(!element.contains(inner));

			root.disconnect();
		});
    </script>
    <div id="one" data-bind="one">
      <div id="inner-one"></div>
    </div>
    <script>
		QUnit.test("One element when array length one", function(assert) {

			function OneObject() {

				this.one = [{}];
			}

			var one = new OneObject();

			var root = new BindingRoot(one);

			var element = document.querySelector("#one");

			var inner = document.querySelector("#inner-one_0");

			assert.ok(element.contains(inner));

			root.disconnect();
		});
    </script>
    <div id="two" data-bind="two">
      <div class="two"></div>
    </div>
    <script>
		QUnit.test("Two elements when array length two", function(assert) {

			function TwoObject() {

				this.two = [{}, {}];
			}

			var two = new TwoObject();

			var root = new BindingRoot(two);

			var element = document.querySelector("#two");

			var childCount = element.querySelectorAll(".two").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="remove" data-bind="remove">
      <div id="remove-one"></div>
    </div>
    <script>
		QUnit.test("Remove elements when array set to null", function(assert) {

			function RemoveObject() {

				this.remove = [{}];
			}

			var remove = new RemoveObject();

			var element = document.querySelector("#remove");

			var root = new BindingRoot(remove);

			remove.remove = null;

			assert.strictEqual(element.children.length, 0);

			root.disconnect();
		});
    </script>
    <div id="after" data-bind="after">
      <div class="after"></div>
    </div>
    <script>
		QUnit.test("Bind array after root", function(assert) {

			function AfterObject() {

				this.after = null;
			}

			var after = new AfterObject();

			var root = new BindingRoot(after);

			after.after = [{}, {}];

			var element = document.querySelector("#after");

			var childCount = element.querySelectorAll(".after").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="reassign" data-bind="reassign">
      <div class="reassign"></div>
    </div>
    <script>
		QUnit.test("Reassign array", function(assert) {

			function ReassignObject() {

				this.reassign = [{}, {}];
			}

			var reassign = new ReassignObject();

			var root = new BindingRoot(reassign);

			reassign.reassign = [{}, {}];

			var element = document.querySelector("#reassign");

			var childCount = element.querySelectorAll(".reassign").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="remove-all" data-bind="removeAll">
      <div id="removeOne"></div>
    </div>
    <script>
		QUnit.test("Remove element when bound to empty array", function(assert) {

			function RemoveAll() {

				this.removeAll = [];
			}

			var element = document.querySelector("#remove-all");

			var each = new RemoveAll();

			var root = new BindingRoot(each);

			assert.strictEqual(element.children.length, 0);

			root.disconnect();
		});
    </script>
    <div data-bind="onlyOne">
      <div></div>
      <div></div>
    </div>
    <script>
		QUnit.test("Exception if multiple elements", function(assert) {

			var exception;

			var root;

			function OnlyOneObject() {

				this.onlyOne = [{}];
			}

			try {

				var onlyOne = new OnlyOneObject();

				root = new BindingRoot(onlyOne);
			}
			catch (e) {

				exception = e;
			}

			assert.ok(exception);
			assert.strictEqual(
				exception.message,
				"An array must be bound to an element with exactly one child.");
		});
    </script>
    <div id="inside" data-bind="inside">
      <div>
        <div id="inside-one" data-bind="innerAll"></div>
      </div>
    </div>
    <script>
		QUnit.test("Apply binding inside array", function(assert) {

			function InsideObject() {

				this.inside = [{

					innerAll: new Binding({

						text: function() { return "Hello World"; }
					})
				}];
			}

			var inside = new InsideObject();

			var root = new BindingRoot(inside);

			var element = document.querySelector("#inside-one_0");

			assert.strictEqual(element.innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="number-outer" data-bind="thenumber">
      <div id="number"></div>
    </div>
	<script>
		QUnit.test("Number ids", function(assert) {

			function NumberObject() {

				this.thenumber = [{}, {}];
			}

			var thenumber = new NumberObject();

			var root = new BindingRoot(thenumber);

			var element = document.querySelector("#number-outer");

			var one = element.querySelector("#number_0");
			var two = element.querySelector("#number_1");

			assert.ok(one);
			assert.ok(two);

			root.disconnect();
		});
    </script>
    <div id="number-name" data-bind="name">
      <div name="name"></div>
    </div>
    <script>
		QUnit.test("Number names", function(assert) {

			function NameObject() {

				this.name = [{}, {}];
			}

			var name = new NameObject();

			var root = new BindingRoot(name);

			var element = document.querySelector("#number-name");

			var one = element.querySelector("[name=name_0]");
			var two = element.querySelector("[name=name_1]");

			assert.ok(one);
			assert.ok(two);

			root.disconnect();
		});
    </script>
    <div id="subnumber" data-bind="subnumber">
      <div>
        <div id="inner-subnumber"></div>
      </div>
    </div>
    <script>
		QUnit.test("Number ids on subelements", function(assert) {

			function SubnumberObject() {

				this.subnumber = [{}];
			}

			var subnumber = new SubnumberObject();

			var root = new BindingRoot(subnumber);

			var element = document.querySelector("#subnumber");

			var one = element.querySelector("#inner-subnumber_0");

			assert.ok(one);
			assert.ok(two);

			root.disconnect();
		});
    </script>
    <div id="string" data-bind="str">
      <div class="string"></div>
    </div>
    <script>
		QUnit.test("Bind to string array", function(assert) {

			function StringObject() {

				this.str = ["thingy", "sumpt"];
			}

			var str = new StringObject();

			var root = new BindingRoot(str);

			var element = document.querySelector("#string");

			var childCount = element.querySelectorAll(".string").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="null" data-bind="nullProperty">
      <div class="null"></div>
    </div>
    <script>
		QUnit.test("Bind array with null element", function(assert) {

			function NullObject() {

				this.nullProperty = [null, {}];
			}

			var nullObject = new NullObject();

			var root = new BindingRoot(nullObject);

			var element = document.querySelector("#null");

			var childCount = element.querySelectorAll(".null").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="square" data-bind="square">
      <div>
        <div class="square"></div>
      </div>
    </div>
    <script>
		QUnit.test("Bind square array", function(assert) {

			function SquareObject() {

				this.square =
					[
						[{}, {}],
						[{}, {}]
					];
			}

			var square = new SquareObject();

			var root = new BindingRoot(square);

			var element = document.querySelector("#square");

			var childCount = element.querySelectorAll(".square").length;

			assert.strictEqual(childCount, 4);

			root.disconnect();
		});
    </script>
    <div id="binding" data-bind="binding">
      <div></div>
    </div>
    <script>
		QUnit.test("Bind array containing binding", function(assert) {

			function BindingObject() {

				this.binding =
					[
						{},
						new Binding({

							text: function() { return "Hello World"; }
						})
					];
			}

			var bindingObject = new BindingObject();

			var root = new BindingRoot(bindingObject);

			var element = document.querySelector("#binding");

			var children = element.children;

			assert.strictEqual(children.length, 2);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="push-binding" data-bind="pushBinding">
      <div></div>
    </div>
    <script>
		QUnit.test("Push binding to bound array", function(assert) {

			function PushBindingObject() {

				this.pushBinding = [{}];
			}

			var pushBindingObject = new PushBindingObject();

			var root = new BindingRoot(pushBindingObject);

			pushBindingObject.pushBinding.push(
				new Binding({

					text: function() { return "Hello World"; }
				}));

			var element = document.querySelector("#push-binding");

			var children = element.children;

			assert.strictEqual(children.length, 2);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="length" data-bind="length">
      <div class="length"></div>
    </div>
    <div data-bind="update"></div>
    <script>
		QUnit.test("Update subscribable length when array updated", function(assert) {

			var lengthUpdateCount = 0;

			function LengthObject() {

				this.length = [{}];

				this.update = new Binding({

					update: function() {

						var thingy = this.length.subscribableLength;

						lengthUpdateCount++;
					}
				});
			}

			var length = new LengthObject();

			var root = new BindingRoot(length);

			length.length.push({});

			length.length.pop();

			length.length.unshift({});

			length.length.shift();

			length.length.splice(0);

			assert.strictEqual(lengthUpdateCount, 6);

			root.disconnect();
		});
    </script>
    <div data-bind="twice">
      <div data-bind="twiceArray">
        <div class="twice"></div>
      </div>
    </div>
    <script>
		QUnit.test("One element bound twice to an array", function(assert) {

			function TwiceObject() {

				this.twice = {

					twiceArray: [{}, {}]
				};
			}

			var twice = new TwiceObject();

			var root = new BindingRoot(twice);

			twice.twice = {

				twiceArray: [{}, new Text(function() { return "Hello world."; }), {}]
			};

			var childCount = document.querySelectorAll(".twice").length;

			assert.strictEqual(childCount, 3);

			root.disconnect();
		});
    </script>
  </body>
</html>
