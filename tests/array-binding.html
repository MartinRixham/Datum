<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Array Binding Tests</title>
    <link rel="stylesheet" href="../node_modules/qunitjs/qunit/qunit.css">
    <script src="../node_modules/qunitjs/qunit/qunit.js"></script>
    <script src="../src/Registry.js"></script>
    <script src="../src/Subscriber.js"></script>
    <script src="../src/UniqueRoot.js"></script>
    <script src="../src/BindingRoot.js"></script>
    <script src="../src/ViewModel.js"></script>
    <script src="../src/Property.js"></script>
    <script src="../src/Binding.js"></script>
    <script src="../src/ArrayBinding.js"></script>
    <script src="../src/ArrayElement.js"></script>
    <script src="../src/Push.js"></script>
    <script src="../src/Pop.js"></script>
    <script src="../src/Shift.js"></script>
    <script src="../src/Unshift.js"></script>
    <script src="../src/Splice.js"></script>
    <script src="../src/Sort.js"></script>
    <script src="../src/Reverse.js"></script>
    <script src="../src/ObjectBinding.js"></script>
  	<script src="../src/Serialisable.js"></script>
    <script src="../src/DomWatcher.js"></script>
    <script src="../src/Datum.js"></script>
    <script src="../src/Dependant.js"></script>
    <script src="../src/Text.js"></script>
    <script src="../src/Value.js"></script>
    <script src="../src/Init.js"></script>
    <script src="../src/Update.js"></script>
    <script src="../src/Click.js"></script>
  </head>
  <body>
    <style>
		#qunit ~ * {
			display: none;
		}
    </style>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script>
		QUnit.module("", {

			teardown: function() {

				Subscriber.prototype = new Registry();
				Binding.prototype = new Subscriber();
				Datum.prototype = new Subscriber();
				Text.prototype = new Subscriber();
				Value.prototype = new Subscriber();
				Update.prototype = new Subscriber();
				UniqueRoot.prototype = new Subscriber();
				BindingRoot.prototype = new UniqueRoot();
				BindingRoot.ObjectBinding.prototype = new Subscriber();
				BindingRoot.ViewModel.prototype = new Subscriber();
				BindingRoot.ArrayBinding.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Push.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Pop.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Shift.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Unshift.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Splice.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Sort.prototype = new Subscriber();
				BindingRoot.ArrayBinding.Reverse.prototype = new Subscriber();
			}
		});
    </script>
    <div id="each" data-bind="each">
      <div id="inner-each"></div>
    </div>
    <script>
		QUnit.test("Remove element when bound to empty array", function(assert) {

			function ArrayBindingObject() {

				this.each = [];
			}

			var element = document.querySelector("#each");

			var inner = document.querySelector("#inner-each_0");

			var each = new ArrayBindingObject();

			var root = new BindingRoot(each);

			assert.ok(!element.contains(inner));

			root.disconnect();
		});
    </script>
    <div id="one" data-bind="one">
      <div id="inner-one"></div>
    </div>
    <script>
		QUnit.test("One element when array length one", function(assert) {

			function OneObject() {

				this.one = [{}];
			}

			var one = new OneObject();

			var root = new BindingRoot(one);

			var element = document.querySelector("#one");

			var inner = document.querySelector("#inner-one_0");

			assert.ok(element.contains(inner));

			root.disconnect();
		});
    </script>
    <div id="two" data-bind="two">
      <div class="two"></div>
    </div>
    <script>
		QUnit.test("Two elements when array length two", function(assert) {

			function TwoObject() {

				this.two = [{}, {}];
			}

			var two = new TwoObject();

			var root = new BindingRoot(two);

			var element = document.querySelector("#two");

			var childCount = element.querySelectorAll(".two").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="remove" data-bind="remove">
      <div id="remove-one"></div>
    </div>
    <script>
		QUnit.test("Remove elements when array set to null", function(assert) {

			function RemoveObject() {

				this.remove = [{}];
			}

			var remove = new RemoveObject();

			var element = document.querySelector("#remove");

			var root = new BindingRoot(remove);

			remove.remove = null;

			assert.strictEqual(element.children.length, 0);

			root.disconnect();
		});
    </script>
    <div id="after" data-bind="after">
      <div class="after"></div>
    </div>
    <script>
		QUnit.test("Bind array after root", function(assert) {

			function AfterObject() {

				this.after = null;
			}

			var after = new AfterObject();

			var root = new BindingRoot(after);

			after.after = [{}, {}];

			var element = document.querySelector("#after");

			var childCount = element.querySelectorAll(".after").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="reassign" data-bind="reassign">
      <div class="reassign"></div>
    </div>
    <script>
		QUnit.test("Reassign array", function(assert) {

			function ReassignObject() {

				this.reassign = [{}, {}];
			}

			var reassign = new ReassignObject();

			var root = new BindingRoot(reassign);

			reassign.reassign = [{}, {}];

			var element = document.querySelector("#reassign");

			var childCount = element.querySelectorAll(".reassign").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="remove-all" data-bind="removeAll">
      <div id="removeOne"></div>
    </div>
    <script>
		QUnit.test("Remove element when bound to empty array", function(assert) {

			function RemoveAll() {

				this.removeAll = [];
			}

			var element = document.querySelector("#remove-all");

			var each = new RemoveAll();

			var root = new BindingRoot(each);

			assert.strictEqual(element.children.length, 0);

			root.disconnect();
		});
    </script>
    <div data-bind="onlyOne">
      <div></div>
      <div></div>
    </div>
    <script>
		QUnit.test("Exception if multiple elements", function(assert) {

			var exception;

			var root;

			function OnlyOneObject() {

				this.onlyOne = [{}];
			}

			try {

				var onlyOne = new OnlyOneObject();

				root = new BindingRoot(onlyOne);
			}
			catch (e) {

				exception = e;
			}

			assert.ok(exception);
			assert.strictEqual(
				exception.message,
				"An array must be bound to an element with exactly one child.");
		});
    </script>
    <div id="inside" data-bind="inside">
      <div>
        <div id="inside-one" data-bind="innerAll"></div>
      </div>
    </div>
    <script>
		QUnit.test("Apply binding inside array", function(assert) {

			function InsideObject() {

				this.inside = [{

					innerAll: new Binding({

						text: function() { return "Hello World"; }
					})
				}];
			}

			var inside = new InsideObject();

			var root = new BindingRoot(inside);

			var element = document.querySelector("#inside-one_0");

			assert.strictEqual(element.innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="number-outer" data-bind="thenumber">
      <div id="number"></div>
    </div>
	<script>
		QUnit.test("Number ids", function(assert) {

			function NumberObject() {

				this.thenumber = [{}, {}];
			}

			var thenumber = new NumberObject();

			var root = new BindingRoot(thenumber);

			var element = document.querySelector("#number-outer");

			var one = element.querySelector("#number_0");
			var two = element.querySelector("#number_1");

			assert.ok(one);
			assert.ok(two);

			root.disconnect();
		});
    </script>
    <div id="number-name" data-bind="name">
      <div name="name"></div>
    </div>
    <script>
		QUnit.test("Number names", function(assert) {

			function NameObject() {

				this.name = [{}, {}];
			}

			var name = new NameObject();

			var root = new BindingRoot(name);

			var element = document.querySelector("#number-name");

			var one = element.querySelector("[name=name_0]");
			var two = element.querySelector("[name=name_1]");

			assert.ok(one);
			assert.ok(two);

			root.disconnect();
		});
    </script>
    <div id="subnumber" data-bind="subnumber">
      <div>
        <div id="inner-subnumber"></div>
      </div>
    </div>
    <script>
		QUnit.test("Number ids on subelements", function(assert) {

			function SubnumberObject() {

				this.subnumber = [{}];
			}

			var subnumber = new SubnumberObject();

			var root = new BindingRoot(subnumber);

			var element = document.querySelector("#subnumber");

			var one = element.querySelector("#inner-subnumber_0");

			assert.ok(one);
			assert.ok(two);

			root.disconnect();
		});
    </script>
    <div id="string" data-bind="str">
      <div class="string"></div>
    </div>
    <script>
		QUnit.test("Bind to string array", function(assert) {

			function StringObject() {

				this.str = ["thingy", "sumpt"];
			}

			var str = new StringObject();

			var root = new BindingRoot(str);

			var element = document.querySelector("#string");

			var childCount = element.querySelectorAll(".string").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="null" data-bind="nullProperty">
      <div class="null"></div>
    </div>
    <script>
		QUnit.test("Bind array with null element", function(assert) {

			function NullObject() {

				this.nullProperty = [null, {}];
			}

			var nullObject = new NullObject();

			var root = new BindingRoot(nullObject);

			var element = document.querySelector("#null");

			var childCount = element.querySelectorAll(".null").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="splice-remove" data-bind="spliceRemove">
      <div class="splice-remove"></div>
    </div>
    <script>
		QUnit.test("Remove element with splice", function(assert) {

			function SpliceRemoveObject() {

				this.spliceRemove = [{}, {}, {}];
			}

			var spliceRemove = new SpliceRemoveObject();

			var root = new BindingRoot(spliceRemove);

			spliceRemove.spliceRemove.splice(1, 1);

			assert.strictEqual(spliceRemove.spliceRemove.length, 2);

			var element = document.querySelector("#splice-remove");

			var childCount =
				element.querySelectorAll(".splice-remove").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();
		});
    </script>
    <div id="splice-remove-two" data-bind="spliceRemoveTwo">
      <div class="splice-remove-two"></div>
    </div>
    <script>
		QUnit.test("Remove two elements with splice", function(assert) {

			function SpliceRemoveTwoObject() {

				this.spliceRemoveTwo = [{}, {}, {}];
			}

			var spliceRemoveTwo = new SpliceRemoveTwoObject();

			var root = new BindingRoot(spliceRemoveTwo);

			spliceRemoveTwo.spliceRemoveTwo.splice(1, 2);

			assert.strictEqual(spliceRemoveTwo.spliceRemoveTwo.length, 1);

			var element = document.querySelector("#splice-remove-two");

			var childCount =
				element.querySelectorAll(".splice-remove-two").length;

			assert.strictEqual(childCount, 1);

			root.disconnect();
		});
    </script>
    <div id="splice-add" data-bind="spliceAdd">
      <div>
        <div class="splice-add" data-bind="spliceText"></div>
      </div>
    </div>
    <script>
		QUnit.test("Add element with splice", function(assert) {

			function SpliceAddObject() {

				this.spliceAdd = [{}, {}];
			}

			var spliceAdd = new SpliceAddObject();

			var root = new BindingRoot(spliceAdd);

			spliceAdd.spliceAdd.splice(1, 0, {

				spliceText: new Text(function() { return "Hello World"; })
			});

			assert.strictEqual(spliceAdd.spliceAdd.length, 3);

			var element = document.querySelector("#splice-add");

			var children = element.querySelectorAll(".splice-add");

			assert.strictEqual(children.length, 3);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="splice-add-two" data-bind="spliceAddTwo">
      <div>
        <div class="splice-add-two" data-bind="spliceText"></div>
      </div>
    </div>
    <script>
		QUnit.test("Add two elements with splice", function(assert) {

			function SpliceAddTwoObject() {

				this.spliceAddTwo = [{}, {}];
			}

			var spliceAddTwo = new SpliceAddTwoObject();

			var root = new BindingRoot(spliceAddTwo);

			spliceAddTwo.spliceAddTwo.splice(1, 0, {

				spliceText: new Text(function() {

					return "Hello World";
				})
			},
			{
				spliceText: new Text(function() {

					return "Eh Up Planet";
				})
			});

			assert.strictEqual(spliceAddTwo.spliceAddTwo.length, 4);

			var element = document.querySelector("#splice-add-two");

			var children = element.querySelectorAll(".splice-add-two");

			assert.strictEqual(children.length, 4);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			assert.strictEqual(children[2].innerHTML, "Eh Up Planet");

			root.disconnect();
		});
    </script>
    <div id="splice-add-remove" data-bind="spliceAddRemove">
      <div>
        <div class="splice-add-remove" data-bind="spliceText"></div>
      </div>
    </div>
    <script>
		QUnit.test("Add and remove element with splice", function(assert) {

			function SpliceAddRemoveObject() {

				this.spliceAddRemove = [{}, {}];
			}

			var spliceAddRemove = new SpliceAddRemoveObject();

			var root = new BindingRoot(spliceAddRemove);

			spliceAddRemove.spliceAddRemove.splice(1, 1, {

				spliceText: new Text(function() { return "Hello World"; })
			});

			assert.strictEqual(spliceAddRemove.spliceAddRemove.length, 2);

			var element = document.querySelector("#splice-add-remove");

			var children = element.querySelectorAll(".splice-add-remove");

			assert.strictEqual(children.length, 2);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="square" data-bind="square">
      <div>
        <div class="square"></div>
      </div>
    </div>
    <script>
		QUnit.test("Bind square array", function(assert) {

			function SquareObject() {

				this.square =
					[
						[{}, {}],
						[{}, {}]
					];
			}

			var square = new SquareObject();

			var root = new BindingRoot(square);

			var element = document.querySelector("#square");

			var childCount = element.querySelectorAll(".square").length;

			assert.strictEqual(childCount, 4);

			root.disconnect();
		});
    </script>
    <div id="binding" data-bind="binding">
      <div></div>
    </div>
    <script>
		QUnit.test("Bind array containing binding", function(assert) {

			function BindingObject() {

				this.binding =
					[
						{},
						new Binding({

							text: function() { return "Hello World"; }
						})
					];
			}

			var bindingObject = new BindingObject();

			var root = new BindingRoot(bindingObject);

			var element = document.querySelector("#binding");

			var children = element.children;

			assert.strictEqual(children.length, 2);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="push-binding" data-bind="pushBinding">
      <div></div>
    </div>
    <script>
		QUnit.test("Push binding to bound array", function(assert) {

			function PushBindingObject() {

				this.pushBinding = [{}];
			}

			var pushBindingObject = new PushBindingObject();

			var root = new BindingRoot(pushBindingObject);

			pushBindingObject.pushBinding.push(
				new Binding({

					text: function() { return "Hello World"; }
				}));

			var element = document.querySelector("#push-binding");

			var children = element.children;

			assert.strictEqual(children.length, 2);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();
		});
    </script>
    <div id="sort-two" data-bind="sortTwo">
      <div class="sort-two" id="sort-two-child"></div>
    </div>
    <script>
		QUnit.test("Sort two element bound array", function(assert) {

			function SortTwo() {

				this.sortTwo = [2, 1];
			}

			var sortTwo = new SortTwo();

			var root = new BindingRoot(sortTwo);

			sortTwo.sortTwo.sort();

			assert.strictEqual(sortTwo.sortTwo.length, 2);

			var element = document.querySelector("#sort-two");

			var children = element.querySelectorAll(".sort-two");

			assert.strictEqual(children.length, 2);

			assert.strictEqual(sortTwo.sortTwo[0], 1);
			assert.strictEqual(sortTwo.sortTwo[1], 2);

			assert.strictEqual(children[0].id, "sort-two-child_1");
			assert.strictEqual(children[1].id, "sort-two-child_0");

			root.disconnect();
		});
    </script>
      <div id="sort-three" data-bind="sortThree">
        <div class="sort-three" id="sort-three-child"></div>
      </div>
    <script>
		QUnit.test("Sort three element bound array", function(assert) {

			function SortThree() {

				this.sortThree = [2, 3, 1];
			}

			var sortThree = new SortThree();

			var root = new BindingRoot(sortThree);

			sortThree.sortThree.sort();

			assert.strictEqual(sortThree.sortThree.length, 3);

			var element = document.querySelector("#sort-three");

			var children = element.querySelectorAll(".sort-three");

			assert.strictEqual(children.length, 3);

			assert.strictEqual(sortThree.sortThree[0], 1);
			assert.strictEqual(sortThree.sortThree[1], 2);
			assert.strictEqual(sortThree.sortThree[2], 3);

			assert.strictEqual(children[0].id, "sort-three-child_2");
			assert.strictEqual(children[1].id, "sort-three-child_0");
			assert.strictEqual(children[2].id, "sort-three-child_1");

			root.disconnect();
		});
    </script>
    <div id="sort-comparer" data-bind="sortComparer">
      <div class="sort-comparer" id="sort-comparer-child"></div>
    </div>
    <script>
		QUnit.test("Sort three element array with a compare function", function(assert) {

			function SortComparer() {

				this.sortComparer = ["am", "me.", "I"];
			}

			var sortComparer = new SortComparer();

			var root = new BindingRoot(sortComparer);

			sortComparer.sortComparer.sort(function(a, b) {

				if (a.length > b.length) {

					return 1;
				}

				if (a.length < b.length) {

					return -1;
				}

				return 0;
			});

			assert.strictEqual(sortComparer.sortComparer.length, 3);

			var element = document.querySelector("#sort-comparer");

			var children = element.querySelectorAll(".sort-comparer");

			assert.strictEqual(children.length, 3);

			assert.strictEqual(sortComparer.sortComparer[0], "I");
			assert.strictEqual(sortComparer.sortComparer[1], "am");
			assert.strictEqual(sortComparer.sortComparer[2], "me.");

			assert.strictEqual(children[0].id, "sort-comparer-child_2");
			assert.strictEqual(children[1].id, "sort-comparer-child_0");
			assert.strictEqual(children[2].id, "sort-comparer-child_1");

			root.disconnect();
		});
    </script>
    <div id="reverse" data-bind="reverse">
      <div class="reverse" id="reverse-child"></div>
    </div>
    <script>
		QUnit.test("Reverse three element bound array", function(assert) {

			function Reverse() {

				this.reverse = [2, 3, 1];
			}

			var reverse = new Reverse();

			var root = new BindingRoot(reverse);

			reverse.reverse.reverse();

			assert.strictEqual(reverse.reverse.length, 3);

			var element = document.querySelector("#reverse");

			var children = element.querySelectorAll(".reverse");

			assert.strictEqual(children.length, 3);

			assert.strictEqual(reverse.reverse[0], 1);
			assert.strictEqual(reverse.reverse[1], 3);
			assert.strictEqual(reverse.reverse[2], 2);

			assert.strictEqual(children[0].id, "reverse-child_2");
			assert.strictEqual(children[1].id, "reverse-child_1");
			assert.strictEqual(children[2].id, "reverse-child_0");

			root.disconnect();
		});
    </script>
    <div id="length" data-bind="length">
      <div class="length"></div>
    </div>
    <div data-bind="update"></div>
    <script>
		QUnit.test("Update subscribable length when array updated", function(assert) {

			var lengthUpdateCount = 0;

			function LengthObject() {

				this.length = [{}];

				this.update = new Binding({

					update: function() {

						var thingy = this.length.subscribableLength;

						lengthUpdateCount++;
					}
				});
			}

			var length = new LengthObject();

			var root = new BindingRoot(length);

			length.length.push({});

			length.length.pop();

			length.length.unshift({});

			length.length.shift();

			length.length.splice(0);

			assert.strictEqual(lengthUpdateCount, 6);

			root.disconnect();
		});
    </script>
    <div data-bind="twice">
      <div data-bind="twiceArray">
        <div class="twice"></div>
      </div>
    </div>
    <script>
		QUnit.test("One element bound twice to an array", function(assert) {

			function TwiceObject() {

				this.twice = {

					twiceArray: [{}, {}]
				};
			}

			var twice = new TwiceObject();

			var root = new BindingRoot(twice);

			twice.twice = {

				twiceArray: [{}, new Text(function() { return "Hello world."; }), {}]
			};

			var childCount = document.querySelectorAll(".twice").length;

			assert.strictEqual(childCount, 3);

			root.disconnect();
		});
    </script>
  </body>
</html>
