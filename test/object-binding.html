<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Object Binding Tests</title>
    <link rel="stylesheet" href="../node_modules/qunitjs/qunit/qunit.css">
    <script src="../node_modules/qunitjs/qunit/qunit.js"></script>
    <script src="../node_modules/requirejs/require.js"></script>
  </head>
  <body>
    <style>
		#qunit ~ * {
			display: none;
		}
    </style>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
	<script>
		var i = 0;

		function getRequire() {

			return require.config({ baseUrl: "../src", context: i++ });
		}
	</script>
    <div id="outer" data-bind="with">
      <div id="with"></div>
    </div>
    <script>
	QUnit.test("Remove element bound to null", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function WithObject() {

				this.with = null;
			}

			var outer = document.querySelector("#outer");

			var element = document.querySelector("#with");

			var root = new BindingRoot(new WithObject());

			assert.ok(!outer.contains(element));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="remove" data-bind="remove">
      <div id="inner"></div>
    </div>
    <script>
	QUnit.test("Remove element when object set to null", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function RemoveObject() {

				this.remove = {};
			}

			var element = document.querySelector("#remove");

			var inner = document.querySelector("#inner");

			var remove = new RemoveObject();

			var root = new BindingRoot(remove);

			remove.remove = null;

			assert.ok(!element.contains(inner));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="replace" data-bind="replace">
      <div id="inner-replace"></div>
    </div>
    <script>
	QUnit.test("Replace element when object added", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function ReplaceObject() {

				this.replace = null;
			}

			var replace = new ReplaceObject();

			var root = new BindingRoot(replace);

			replace.replace = {};

			var element = document.querySelector("#replace");

			var inner = document.querySelector("#inner-replace");

			assert.ok(element.contains(inner));

			root.disconnect();

			done();
		});
	});
    </script>
    <div data-bind="bind">
      <div id="text" data-bind="text"></div>
    </div>
    <script>
	QUnit.test("Apply binding when object added", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot", "Binding"], function(BindingRoot, Binding) {

			function ApplyObject() {

				this.bind = null;
			}

			var bind = new ApplyObject();

			var root = new BindingRoot(bind);

			bind.bind = {

				text: new Binding({

					text: function() {
						return "Hello World";
					}
				})
			};

			assert.strictEqual(document.querySelector("#text").innerHTML, "Hello World");

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="multi-outer" data-bind="multi">
      <div id="one"></div>
      <div id="two"></div>
    </div>
    <script>
	QUnit.test("Remove all elements when bound to null", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function MultipleObject() {

				this.multi = null;
			}

			var outer = document.querySelector("#multi-outer");

			var one = document.querySelector("#one");
			var two = document.querySelector("#two");

			var root = new BindingRoot(new MultipleObject());

			assert.ok(!outer.contains(one));
			assert.ok(!outer.contains(two));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="multi-remove" data-bind="removeMulti">
      <div id="remove-one"></div>
      <div id="remove-two"></div>
    </div>
    <script>
	QUnit.test("Remove all elements when object set to null", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function RemoveObject() {

				this.removeMulti = {};
			}

			var element = document.querySelector("#multi-remove");

			var one = document.querySelector("#remove-one");
			var two = document.querySelector("#remove-two");

			var remove = new RemoveObject();

			var root = new BindingRoot(remove);

			remove.removeMulti = null;

			assert.ok(!element.contains(one));
			assert.ok(!element.contains(two));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="multi-replace" data-bind="Multireplace">
      <div id="replace-one"></div>
      <div id="replace-two"></div>
    </div>
    <script>
	QUnit.test("Replace all elements when object added", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function ReplaceObject() {

				this.Multireplace = null;
			}

			var replace = new ReplaceObject();

			var root = new BindingRoot(replace);

			replace.Multireplace = {};

			var element = document.querySelector("#multi-replace");

			var one = document.querySelector("#replace-one");
			var two = document.querySelector("#replace-two");

			assert.ok(element.contains(one));
			assert.ok(element.contains(two));

			var elementCount =
				document.querySelectorAll(
					"[data-bind=Multireplace]").length;

			assert.strictEqual(elementCount, 1);

			assert.ok(one.nextSibiling = two);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="reremove" data-bind="reremove">
      <div id="inner-reremove"></div>
    </div>
    <script>
	QUnit.test("Reremove element", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function ReremoveObject() {

				this.reremove = null;
			}

			var reremove = new ReremoveObject();

			var root = new BindingRoot(reremove);

			reremove.reremove = {};

			var inner = document.querySelector("#inner-reremove");

			reremove.reremove = null;

			var element = document.querySelector("#reremove");

			assert.ok(!element.contains(inner));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="renull" data-bind="renull">
      <div id="inner-null"></div>
    </div>
    <script>
	QUnit.test("Reset object to null", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function RenullObject() {

				this.renull = null;
			}

			var element = document.querySelector("#renull");

			var inner = document.querySelector("#inner-renull");

			var renull = new RenullObject();

			var root = new BindingRoot(renull);

			renull.renull = null;

			assert.ok(!element.contains(inner));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="renew" data-bind="renew">
      <div id="inner-renew"></div>
    </div>
    <script>
	QUnit.test("Reassign object", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function RenewObject() {

				this.renew = {};
			}

			var element = document.querySelector("#renew");

			var inner = document.querySelector("#inner-renew");

			var renew = new RenewObject();

			var root = new BindingRoot(renew);

			renew.renew = {};

			assert.ok(element.children.length == 1);

			root.disconnect();

			done();
		});
	});
    </script>
    <div data-bind="object"></div>
    <div data-bind="subobject">
      <div id="subobject-text" data-bind="text"></div>
    </div>
    <script>
	QUnit.test("Subobjects not bound outside of scope", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function SubobjectObject() {

				this.object = {

					subobject: {

						text: new Binding({

							text: function() {
								return "Hello World";
							}
						})
					}
				};
			}

			var root;

			try {

				root = new BindingRoot(new SubobjectObject());
			}
			catch (e) {
			}
			finally {

				var text = document.querySelector("#subobject-text");

				assert.notEqual(text.innerHTML, "Hello World");

				if (root) {

					root.disconnect();
				}

				done();
			}
		});
	});
    </script>
    <div data-bind="subscope">
      <div data-bind="subscopeobject">
        <div id="subscope-text" data-bind="text"></div>
      </div>
    </div>
    <script>
	QUnit.test("Subobjects not bound inside subscope", function(assert) {

		var done = assert.async();

		getRequire()(["Binding", "BindingRoot"], function(Binding, BindingRoot) {

			function SubscopeObject() {

				this.subscope = {};

				this.subscopeobject = {

					text: new Binding({

						text: function() {
							return "Hello World";
						}
					})
				};
			}

			var root = new BindingRoot(new SubscopeObject());

			var text = document.querySelector("#subscope-text");

			assert.notEqual(text.innerHTML, "Hello World");

			root.disconnect();

			done();
		});
	});
    </script>
  </body>
</html>
