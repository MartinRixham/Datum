<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Array Binding Tests</title>
    <link rel="stylesheet" href="../node_modules/qunitjs/qunit/qunit.css">
    <script src="../node_modules/qunitjs/qunit/qunit.js"></script>
    <script src="../node_modules/requirejs/require.js"></script>
  </head>
  <body>
    <style>
	    #qunit ~ * {
		    display: none;
	    }
    </style>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
	<script>
		var i = 0;

		function getRequire() {

			return require.config({ baseUrl: "../src", context: i++ });
		}
	</script>
    <div id="each" data-bind="each">
      <div id="inner-each"></div>
    </div>
    <script>
	QUnit.test("Remove element when bound to empty array", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function ArrayBindingObject() {

				this.each = [];
			}

			var element = document.querySelector("#each");

			var inner = document.querySelector("#inner-each_0");

			var each = new ArrayBindingObject();

			var root = new BindingRoot(each);

			assert.ok(!element.contains(inner));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="one" data-bind="one">
      <div id="inner-one"></div>
    </div>
    <script>
	QUnit.test("One element when array length one", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function OneObject() {

				this.one = [{}];
			}

			var one = new OneObject();

			var root = new BindingRoot(one);

			var element = document.querySelector("#one");

			var inner = document.querySelector("#inner-one_0");

			assert.ok(element.contains(inner));

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="two" data-bind="two">
      <div class="two"></div>
    </div>
    <script>
	QUnit.test("Two elements when array length two", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function TwoObject() {

				this.two = [{}, {}];
			}

			var two = new TwoObject();

			var root = new BindingRoot(two);

			var element = document.querySelector("#two");

			var childCount = element.querySelectorAll(".two").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="remove" data-bind="remove">
      <div id="remove-one"></div>
    </div>
    <script>
	QUnit.test("Remove elements when array set to null", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function RemoveObject() {

				this.remove = [{}];
			}

			var remove = new RemoveObject();

			var element = document.querySelector("#remove");

			var root = new BindingRoot(remove);

			remove.remove = null;

			assert.strictEqual(element.children.length, 0);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="after" data-bind="after">
      <div class="after"></div>
    </div>
    <script>
	QUnit.test("Bind array after root", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function AfterObject() {

				this.after = null;
			}

			var after = new AfterObject();

			var root = new BindingRoot(after);

			after.after = [{}, {}];

			var element = document.querySelector("#after");

			var childCount = element.querySelectorAll(".after").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="reassign" data-bind="reassign">
      <div class="reassign"></div>
    </div>
    <script>
	QUnit.test("Reassign array", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function ReassignObject() {

				this.reassign = [{}, {}];
			}

			var reassign = new ReassignObject();

			var root = new BindingRoot(reassign);

			reassign.reassign = [{}, {}];

			var element = document.querySelector("#reassign");

			var childCount = element.querySelectorAll(".reassign").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="remove-all" data-bind="removeAll">
      <div id="removeOne"></div>
    </div>
    <script>
	QUnit.test("Remove element when bound to empty array", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function RemoveAll() {

				this.removeAll = [];
			}

			var element = document.querySelector("#remove-all");

			var each = new RemoveAll();

			var root = new BindingRoot(each);

			assert.strictEqual(element.children.length, 0);

			root.disconnect();

			done();
		});
	});
    </script>
    <div data-bind="onlyOne">
      <div></div>
      <div></div>
    </div>
    <script>
	QUnit.test("Exception if multiple elements", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			var exception;

			var root;

			function OnlyOneObject() {

				this.onlyOne = [{}];
			}

			try {

				var onlyOne = new OnlyOneObject();

				root = new BindingRoot(onlyOne);
			}
			catch (e) {

				exception = e;
			}

			assert.ok(exception);
			assert.strictEqual(
				exception.message,
				"An array must be bound to an element with exactly one child.");

			done();
		});
	});
    </script>
    <div id="inside" data-bind="inside">
      <div>
        <div id="inside-one" data-bind="innerAll"></div>
      </div>
    </div>
    <script>
	QUnit.test("Apply binding inside array", function(assert) {

		var done = assert.async();

		getRequire()(["Binding", "BindingRoot"], function(Binding, BindingRoot) {

			function InsideObject() {

				this.inside = [{

					innerAll: new Binding({

						text: function() {
							return "Hello World";
						}
					})
				}];
			}

			var inside = new InsideObject();

			var root = new BindingRoot(inside);

			var element = document.querySelector("#inside-one_0");

			assert.strictEqual(element.innerHTML, "Hello World");

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="string" data-bind="str">
      <div class="string"></div>
    </div>
    <script>
	QUnit.test("Bind to string array", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function StringObject() {

				this.str = ["thingy", "sumpt"];
			}

			var str = new StringObject();

			var root = new BindingRoot(str);

			var element = document.querySelector("#string");

			var childCount = element.querySelectorAll(".string").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="null" data-bind="nullProperty">
      <div class="null"></div>
    </div>
    <script>
	QUnit.test("Bind array with null element", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function NullObject() {

				this.nullProperty = [null, {}];
			}

			var nullObject = new NullObject();

			var root = new BindingRoot(nullObject);

			var element = document.querySelector("#null");

			var childCount = element.querySelectorAll(".null").length;

			assert.strictEqual(childCount, 2);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="square" data-bind="square">
      <div>
        <div class="square"></div>
      </div>
    </div>
    <script>
	QUnit.test("Bind square array", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot"], function(BindingRoot) {

			function SquareObject() {

				this.square =
					[
						[{}, {}],
						[{}, {}]
					];
			}

			var square = new SquareObject();

			var root = new BindingRoot(square);

			var element = document.querySelector("#square");

			var childCount = element.querySelectorAll(".square").length;

			assert.strictEqual(childCount, 4);

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="binding" data-bind="binding">
      <div></div>
    </div>
    <script>
	QUnit.test("Bind array containing binding", function(assert) {

		var done = assert.async();

		getRequire()(["Binding", "BindingRoot"], function(Binding, BindingRoot) {

			function BindingObject() {

				this.binding =
					[
						{},
						new Binding({

							text: function() {
								return "Hello World";
							}
						})
					];
			}

			var bindingObject = new BindingObject();

			var root = new BindingRoot(bindingObject);

			var element = document.querySelector("#binding");

			var children = element.children;

			assert.strictEqual(children.length, 2);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="push-binding" data-bind="pushBinding">
      <div></div>
    </div>
    <script>
	QUnit.test("Push binding to bound array", function(assert) {

		var done = assert.async();

		getRequire()(["Binding", "BindingRoot"], function(Binding, BindingRoot) {

			function PushBindingObject() {

				this.pushBinding = [{}];
			}

			var pushBindingObject = new PushBindingObject();

			var root = new BindingRoot(pushBindingObject);

			pushBindingObject.pushBinding.push(
				new Binding({

					text: function() {
						return "Hello World";
					}
				}));

			var element = document.querySelector("#push-binding");

			var children = element.children;

			assert.strictEqual(children.length, 2);

			assert.strictEqual(children[1].innerHTML, "Hello World");

			root.disconnect();

			done();
		});
	});
    </script>
    <div id="length" data-bind="length">
      <div class="length"></div>
    </div>
    <div data-bind="update"></div>
    <script>
	QUnit.test("Update subscribable length when array updated", function(assert) {

		var done = assert.async();

		getRequire()(["Binding", "BindingRoot"], function(Binding, BindingRoot) {

			var lengthUpdateCount = 0;

			function LengthObject() {

				this.length = [{}];

				this.update = new Binding({

					update: function() {

						var thingy = this.length.subscribableLength;

						lengthUpdateCount++;
					}
				});
			}

			var length = new LengthObject();

			var root = new BindingRoot(length);

			length.length.push({});
			length.length.pop();
			length.length.unshift({});
			length.length.shift();
			length.length.splice(0);

			assert.strictEqual(lengthUpdateCount, 6);

			root.disconnect();

			done();
		});
	});
    </script>
    <div data-bind="twice">
      <div data-bind="twiceArray">
        <div class="twice"></div>
      </div>
    </div>
    <script>
	QUnit.test("One element bound twice to an array", function(assert) {

		var done = assert.async();

		getRequire()(["BindingRoot", "Text"], function(BindingRoot, Text) {

			function TwiceObject() {

				this.twice = {

					twiceArray: [{}, {}]
				};
			}

			var twice = new TwiceObject();

			var root = new BindingRoot(twice);

			twice.twice = {

				twiceArray:
					[
						{},
						new Text(function() { return "Hello world.";}),
						{}
					]
			};

			var childCount = document.querySelectorAll(".twice").length;

			assert.strictEqual(childCount, 3);

			root.disconnect();

			done();
		});
	});
    </script>
  </body>
</html>
